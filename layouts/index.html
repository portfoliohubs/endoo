<!doctype html>
<html lang="{{ .Site.Params.site_language | default "en" }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{{ .Site.Params.site_description }}">
  <title>{{ .Site.Title }}</title>

  {{ hugo.Generator }}

  <style>
    /*
      Architecture decisions (kept minimal):
      - Single Hugo template file to satisfy the 3-file repository constraint.
      - All editable content lives in config.toml (teeth, topics, fast facts, contact).
      - Minimal JS only for selection + deep links; no heavy animations.
    */

    :root {
      --bg: {{ .Site.Params.theme.bg }};
      --surface: {{ .Site.Params.theme.surface }};
      --text: {{ .Site.Params.theme.text }};
      --muted: {{ .Site.Params.theme.muted_text }};
      --border: {{ .Site.Params.theme.border }};
      --brand: {{ .Site.Params.theme.brand }};
      --brand2: {{ .Site.Params.theme.brand_2 }};
      --warning: {{ .Site.Params.theme.warning }};
      --danger: {{ .Site.Params.theme.danger }};
      --info: {{ .Site.Params.theme.info }};
      --success: {{ .Site.Params.theme.success }};
      --accent: {{ .Site.Params.theme.accent }};
      --teal: {{ .Site.Params.theme.teal }};
      --orange: {{ .Site.Params.theme.orange }};

      --maxw: {{ .Site.Params.theme.max_width_ch | default 72 }}ch;

      --radius: 14px;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.06);

      --s1: 8px;
      --s2: 12px;
      --s3: 16px;
      --s4: 24px;
      --s5: 36px;
      --s6: 52px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.55;
      text-rendering: optimizeLegibility;
    }

    html { scroll-behavior: smooth; }

    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .skip-link {
      position: absolute;
      left: -9999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    .skip-link:focus {
      left: var(--s4);
      top: var(--s4);
      width: auto;
      height: auto;
      padding: var(--s2) var(--s3);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      z-index: 1000;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 900;
      background: rgba(255,255,255,0.92);
      backdrop-filter: saturate(120%) blur(8px);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      max-width: calc(var(--maxw) + 44ch);
      margin: 0 auto;
      padding: var(--s3) var(--s4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--s3);
    }

    .brand {
      display: flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .brand strong {
      font-weight: 900;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .brand small {
      color: var(--muted);
      font-weight: 700;
      white-space: nowrap;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    nav a {
      display: inline-flex;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      color: var(--text);
      border: 1px solid transparent;
      font-weight: 700;
      font-size: 14px;
    }

    nav a[aria-current="true"] {
      border-color: var(--border);
      background: var(--surface);
    }

    main {
      max-width: calc(var(--maxw) + 44ch);
      margin: 0 auto;
      padding: var(--s6) var(--s4);
    }

    section { scroll-margin-top: 96px; }

    h1, h2, h3 {
      margin: 0 0 var(--s2) 0;
      line-height: 1.2;
      letter-spacing: -0.2px;
    }

    h1 { font-size: clamp(26px, 4vw, 36px); }
    h2 { font-size: 22px; margin-top: var(--s5); }
    h3 { font-size: 16px; margin-top: var(--s3); }

    p { margin: 0 0 var(--s3) 0; max-width: var(--maxw); }

    .muted { color: var(--muted); }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .card-pad { padding: var(--s4); }

    .kicker {
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }

    .hero {
      padding: var(--s5) var(--s4);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(0,102,204,0.08), rgba(0,168,107,0.06), rgba(139,92,246,0.04));
      border: 1px solid var(--border);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: var(--s3);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      max-width: 100%;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-color: var(--brand);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,102,204,0.25);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,102,204,0.15);
    }

    .divider { height: 1px; background: var(--border); margin: var(--s5) 0; }

    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--s5);
    }

    @media (min-width: 980px) {
      .container {
        grid-template-columns: minmax(280px, 36ch) minmax(0, var(--maxw));
        align-items: start;
      }
    }

    .sidebar h2 {
      margin-top: 0;
      font-size: 16px;
      letter-spacing: 0;
    }

    @media (min-width: 980px) {
      .sidebar-inner {
        position: sticky;
        top: 92px;
      }
    }

    .seg {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: var(--s3);
    }

    .seg button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .seg button[aria-pressed="true"] {
      border-color: var(--brand);
      background: linear-gradient(135deg, rgba(0,102,204,0.1), rgba(0,168,107,0.08));
      box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
      color: var(--brand);
    }

    .tooth-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 10px;
    }

    .tooth-item button {
      width: 100%;
      text-align: left;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
      min-width: 0;
    }

    .tooth-item button .meta {
      display: block;
      margin-top: 6px;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }

    .tooth-item button[aria-pressed="true"] {
      border-color: var(--brand);
      background: linear-gradient(135deg, rgba(0,102,204,0.08), rgba(0,168,107,0.06));
      box-shadow: 0 0 0 3px rgba(0,102,204,0.12);
      color: var(--brand);
    }

    .tooth-item button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .tooth { display: none; }
    .tooth[data-active="true"] { display: block; }

    code {
      font-family: var(--mono);
      font-weight: 800;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .jump {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: var(--s3) 0 var(--s4) 0;
    }

    .jump a {
      display: inline-flex;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .jump a[data-active="true"] {
      border-color: rgba(30,90,168,0.35);
      box-shadow: 0 0 0 3px rgba(30,90,168,0.10);
    }

    .content-block {
      padding: var(--s4);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .facts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: var(--s3);
    }

    @media (min-width: 720px) {
      .facts { grid-template-columns: 1fr 1fr; }
    }

    .fact {
      padding: 12px 12px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, #fff, rgba(0,102,204,0.02));
      border-radius: 12px;
      min-width: 0;
      transition: all 0.2s ease;
    }

    .fact:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,102,204,0.1);
      border-color: rgba(0,102,204,0.2);
    }

    .label {
      display: block;
      color: var(--brand);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    ul, ol {
      margin: 0 0 var(--s3) 1.2em;
      padding: 0;
      max-width: var(--maxw);
      overflow-wrap: anywhere;
    }

    li { margin: 0 0 8px 0; }

    details.topic {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(135deg, #fff, rgba(0,168,107,0.02));
      padding: 0;
      overflow: clip;
      transition: all 0.2s ease;
    }

    details.topic:hover {
      border-color: rgba(0,168,107,0.3);
      box-shadow: 0 2px 8px rgba(0,168,107,0.08);
    }

    details.topic + details.topic { margin-top: 12px; }

    details.topic summary {
      cursor: pointer;
      padding: 14px 14px;
      font-weight: 900;
      list-style: none;
      overflow-wrap: anywhere;
    }

    details.topic summary::-webkit-details-marker { display: none; }

    details.topic[open] summary {
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(0,102,204,0.06), rgba(0,168,107,0.04));
      color: var(--brand);
    }

    .topic-body { padding: 14px 14px; }

    footer {
      margin-top: var(--s6);
      padding-top: var(--s5);
      border-top: 1px solid var(--border);
      color: var(--muted);
    }

    .small { font-size: 13px; }

    .notice {
      border-left: 4px solid var(--info);
      padding: 12px 12px;
      background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(0,168,107,0.04));
      border-radius: 12px;
      color: var(--text);
    }

    @media (max-width: 719px) {
      main { padding: var(--s4) var(--s3); }
      .hero { padding: var(--s4) var(--s3); }
      .card-pad { padding: var(--s3); }
      .facts { grid-template-columns: 1fr; }
      .seg { grid-template-columns: 1fr; }
      .seg button { padding: 12px; font-size: 14px; }
      .tooth-item button { padding: 14px 12px; font-size: 15px; }
      .btn { padding: 12px 14px; font-size: 15px; }
      details.topic summary { padding: 16px 14px; font-size: 15px; }
      .topic-body { padding: 16px 14px; }
      .fact { padding: 14px 12px; }
      h1 { font-size: 24px; }
      h2 { font-size: 20px; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { scroll-behavior: auto !important; }
      .btn:hover, .fact:hover, details.topic:hover { transform: none; }
    }
  </style>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "MedicalWebPage",
      "name": {{ .Site.Title | jsonify }},
      "description": {{ .Site.Params.site_description | jsonify }},
      "url": {{ .Site.BaseURL | jsonify }},
      "audience": {
        "@type": "MedicalAudience",
        "audienceType": "Dental professionals and trainees"
      },
      "about": {
        "@type": "MedicalSpecialty",
        "name": "Endodontics"
      }
    }
  </script>
</head>
<body>
  {{ $page := . }}
  <a class="skip-link" href="#main">Skip to content</a>

  <header>
    <div class="nav">
      <div class="brand">
        <strong>{{ $page.Site.Params.site_name }}</strong>
        <small class="muted">{{ $page.Site.Params.brand_short }}</small>
      </div>

      <nav aria-label="Primary">
        <ul>
          {{ range $page.Site.Params.page_sections }}
            <li><a class="navlink" href="#{{ .id }}">{{ .label }}</a></li>
          {{ end }}
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    {{ range $page.Site.Params.page_sections }}
      {{ $sid := .id }}

      {{ if eq $sid "hero" }}
        <section id="hero" aria-labelledby="hero-title">
          <div class="hero">
            <div class="kicker">Clinical reference</div>
            <h1 id="hero-title">{{ $page.Site.Params.site_tagline }}</h1>
            <p class="muted">{{ $page.Site.Params.site_description }}</p>
            <div class="pill-row">
              <a class="btn primary" href="#protocol">Open Endodontics</a>
              <a class="btn" href="#{{ $page.Site.Params.monetization.cta_target_section }}">{{ $page.Site.Params.monetization.cta_label }}</a>
            </div>
          </div>
        </section>
      {{ end }}

      {{ if eq $sid "specialties" }}
        <section id="specialties" aria-labelledby="specialties-title">
          <h2 id="specialties-title">Specialties</h2>
          <p class="muted">Endodontics is active. Other specialties are prepared for later.</p>

          <div class="card card-pad">
            {{ range $page.Site.Params.specialties }}
              {{ if eq (.status | default "coming_soon") "active" }}
                <div style="display:grid;gap:6px;">
                  <div class="kicker">Active</div>
                  <h3 style="margin:0">{{ .name }}</h3>
                  <p class="muted" style="margin:0">{{ .description }}</p>
                </div>
              {{ end }}
            {{ end }}
            <div class="divider"></div>
            <p class="small muted" style="margin:0">Coming soon: Restorative, Prosthodontics.</p>
          </div>
        </section>
      {{ end }}

      {{ if eq $sid "protocol" }}
        <section id="protocol" aria-labelledby="protocol-title">
          <h2 id="protocol-title">Endodontics — Tooth Protocols</h2>
          <p class="muted">{{ $page.Site.Params.protocols.intro | default "Select a tooth, then open only the topic you need." }}</p>

          <div class="container">
            <aside class="sidebar" aria-label="Tooth selector">
              <div class="sidebar-inner card card-pad">
                <h2>Choose tooth</h2>
                <p class="small muted" style="margin-top: 0">1) Arch  2) Tooth</p>

                <div class="seg" role="group" aria-label="Arch selector">
                  <button type="button" data-arch="maxillary" aria-pressed="false">Maxillary</button>
                  <button type="button" data-arch="mandibular" aria-pressed="false">Mandibular</button>
                </div>

                <ul class="tooth-list" aria-label="Tooth list">
                  {{ range $page.Site.Params.teeth }}
                    {{ if eq .specialty_id "endodontics" }}
                      {{ $tstatus := .status | default "coming_soon" }}
                      <li class="tooth-item" data-arch="{{ .arch }}" data-tooth-id="{{ .id }}">
                        <button type="button" aria-pressed="false" data-select-tooth="{{ .id }}" {{ if ne $tstatus "active" }}disabled{{ end }} aria-disabled="{{ if ne $tstatus "active" }}true{{ else }}false{{ end }}">
                          {{ .name }}
                          <span class="meta">{{ .abbr }} · {{ if eq $tstatus "active" }}Ready{{ else }}Coming soon{{ end }}</span>
                        </button>
                      </li>
                    {{ end }}
                  {{ end }}
                </ul>

                <div class="divider"></div>

                <div class="notice small">
                  <strong>Tip:</strong> Tap a topic (Access, WL, Prep, Obturation…) to open details.
                </div>
              </div>
            </aside>

            <div>
              {{ range $page.Site.Params.teeth }}
                {{ if eq .specialty_id "endodontics" }}
                  {{ $tooth := . }}
                  <article class="tooth" data-tooth-id="{{ .id }}" data-active="false" aria-labelledby="{{ .id }}-title">
                    <div class="card card-pad">
                      <div style="display:grid;gap:10px;">
                        <h2 id="{{ .id }}-title" style="margin-top: 0">{{ .name }}</h2>
                      </div>

                      <div class="content-block" style="margin-top: var(--s3);">
                        <div class="kicker">Fast data</div>
                        <div class="facts" aria-label="Fast facts">
                          <div class="fact">
                            <span class="label">Access cavity</span>
                            <div>{{ .fast.access_cavity }}</div>
                          </div>
                          <div class="fact">
                            <span class="label">Canals</span>
                            <div>{{ .fast.canals }}</div>
                          </div>
                          <div class="fact">
                            <span class="label">Difficulty</span>
                            <div>{{ .fast.typical_difficulty }}</div>
                          </div>
                          <div class="fact">
                            <span class="label">Student focus</span>
                            <ul style="margin-bottom:0;">
                              {{ range .fast.student_focus }}<li>{{ . }}</li>{{ end }}
                            </ul>
                          </div>
                        </div>

                        {{ if .fast.key_risks }}
                          <div style="margin-top:12px;">
                            <span class="label">Key risks</span>
                            <ul style="margin-bottom:0;">
                              {{ range .fast.key_risks }}<li>{{ . }}</li>{{ end }}
                            </ul>
                          </div>
                        {{ end }}
                      </div>

                      <div style="margin-top: var(--s4);" aria-label="Topics">
                        {{ range .topics }}
                          <details class="topic" id="{{ $tooth.id }}-{{ .id }}" data-tooth-topic="{{ $tooth.id }}" data-section-id="{{ $tooth.id }}-{{ .id }}" aria-labelledby="{{ $tooth.id }}-{{ .id }}-h">
                            <summary id="{{ $tooth.id }}-{{ .id }}-h">{{ .title }}</summary>
                            <div class="topic-body">

                              {{ if eq .type "steps" }}
                                <ol>
                                  {{ range .content.steps }}<li>{{ . }}</li>{{ end }}
                                </ol>
                              {{ end }}

                              {{ if eq .type "bullets" }}
                                <ul>
                                  {{ range .content.bullets }}<li>{{ . }}</li>{{ end }}
                                </ul>
                              {{ end }}

                              {{ if eq .type "if_then" }}
                                <ul>
                                  {{ range .rules }}
                                    <li><strong>IF</strong> {{ .if }} <strong>THEN</strong> {{ .then }}</li>
                                  {{ end }}
                                </ul>
                              {{ end }}

                              {{ if eq .type "references" }}
                                <ul>
                                  {{ range .refs }}
                                    <li>
                                      {{ .citation }}
                                      {{ if .year }}<span class="muted">({{ .year }})</span>{{ end }}
                                      {{ if .url }} — <a href="{{ .url }}" rel="noopener" target="_blank">Source</a>{{ end }}
                                    </li>
                                  {{ end }}
                                </ul>
                              {{ end }}
                            </div>
                          </details>
                        {{ end }}
                      </div>
                    </div>
                  </article>
                {{ end }}
              {{ end }}

              <noscript>
                <div class="card card-pad" style="margin-top: var(--s4)">
                  <strong>Note:</strong> JavaScript is disabled. You can still read content, but tooth switching will be limited.
                </div>
              </noscript>
            </div>
          </div>
        </section>
      {{ end }}

      {{ if eq $sid "community" }}
        <section id="community" aria-labelledby="community-title">
          <h2 id="community-title">Community</h2>
          <div class="card card-pad">
            <p class="muted">If something is unclear or unsafe, report it. If you have a practical tip, suggest it.</p>
            <div class="pill-row">
              <a class="btn" href="{{ $page.Site.Params.community.report_issue_href }}">{{ $page.Site.Params.community.report_issue_label }}</a>
              <a class="btn" href="{{ $page.Site.Params.community.suggest_tip_href }}">{{ $page.Site.Params.community.suggest_tip_label }}</a>
            </div>
          </div>
        </section>
      {{ end }}

      {{ if eq $sid "contact" }}
        <section id="contact" aria-labelledby="contact-title">
          <h2 id="contact-title">{{ $page.Site.Params.contact.section_title }}</h2>
          <div class="card card-pad">
            <p class="muted">{{ $page.Site.Params.contact.intro }}</p>
            <div class="pill-row">
              <a class="btn primary" href="{{ $page.Site.Params.contact.email_href }}">{{ $page.Site.Params.contact.email_label }}</a>
              <a class="btn" href="{{ $page.Site.Params.contact.whatsapp_href }}" rel="noopener" target="_blank">{{ $page.Site.Params.contact.whatsapp_label }}</a>
            </div>
            <div class="divider"></div>
            <p class="small muted" style="margin: 0">{{ $page.Site.Params.monetization.cta_note }}</p>
          </div>
        </section>
      {{ end }}
    {{ end }}

    <footer>
      <p class="small" style="margin-bottom: 10px">{{ $page.Site.Params.footer.line_1 }}</p>
      <p class="small" style="margin-top: 0">{{ $page.Site.Params.footer.line_2 }}</p>
      <p class="small" style="margin-top: var(--s4)">
        <a href="#{{ $page.Site.Params.monetization.cta_target_section }}">{{ $page.Site.Params.monetization.cta_label }}</a>
      </p>
    </footer>
  </main>

  <script>
    // Minimal JS: tooth selection + deep links + light scroll highlighting.
    (function () {
      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const navLinks = qsa('.navlink');

      const archButtons = qsa('[data-arch]');
      const toothItems = qsa('.tooth-item');
      const toothButtons = qsa('[data-select-tooth]');
      const teeth = qsa('.tooth');

      function setActiveNav() {
        const sections = navLinks
          .map(a => ({ a, id: (a.getAttribute('href') || '').replace('#', '') }))
          .filter(x => x.id);

        const current = sections
          .map(x => ({...x, el: document.getElementById(x.id)}))
          .filter(x => x.el)
          .sort((a, b) => a.el.getBoundingClientRect().top - b.el.getBoundingClientRect().top)
          .find(x => x.el.getBoundingClientRect().top >= -120) || sections[0];

        navLinks.forEach(a => a.setAttribute('aria-current', 'false'));
        if (current && current.a) current.a.setAttribute('aria-current', 'true');
      }

      function parseHash() {
        // Supported:
        // - #protocol|tooth=<id>
        // - #<toothId>-<topicId>
        const h = (location.hash || '').replace('#', '');
        const parts = h.split('|');
        const toothPart = parts.find(p => p.startsWith('tooth='));
        if (toothPart) return { toothId: decodeURIComponent(toothPart.replace('tooth=', '')), topicId: null };

        if (h) {
          const ids = teeth.map(t => t.getAttribute('data-tooth-id')).filter(Boolean);
          const match = ids.find(id => h === id || h.startsWith(id + '-'));
          if (match) {
            const topicId = (h.startsWith(match + '-') ? h.replace(match + '-', '') : null);
            return { toothId: match, topicId };
          }
        }

        return { toothId: null, topicId: null };
      }

      function setArch(arch) {
        archButtons.forEach(b => {
          const isMatch = b.getAttribute('data-arch') === arch;
          b.setAttribute('aria-pressed', isMatch ? 'true' : 'false');
        });

        toothItems.forEach(li => {
          const show = li.getAttribute('data-arch') === arch;
          li.style.display = show ? '' : 'none';
        });

        teeth.forEach(t => {
          const show = t.getAttribute('data-arch') === arch;
          if (!show) t.setAttribute('data-active', 'false');
        });
      }

      let jumpObserver = null;

      function setupJumpSpy(toothId) {
        if (jumpObserver) jumpObserver.disconnect();
        const jump = qs('[data-jump-for="' + CSS.escape(toothId) + '"]');
        if (!jump) return;

        const links = qsa('a[data-jump]', jump);
        const topics = qsa('[data-tooth-topic="' + CSS.escape(toothId) + '"]');

        function markActive(sectionId) {
          links.forEach(a => {
            const isActive = a.getAttribute('data-jump') === sectionId;
            a.setAttribute('data-active', isActive ? 'true' : 'false');
          });
        }

        jumpObserver = new IntersectionObserver((entries) => {
          const visible = entries
            .filter(e => e.isIntersecting)
            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];

          if (visible && visible.target) {
            markActive(visible.target.getAttribute('data-section-id'));
          }
        }, { root: null, threshold: [0.15, 0.25, 0.4], rootMargin: '-10% 0px -70% 0px' });

        topics.forEach(t => jumpObserver.observe(t));
      }

      function openTopic(toothId, topicId) {
        if (!topicId) return;
        const el = document.getElementById(toothId + '-' + topicId);
        if (!el) return;
        if (el.tagName && el.tagName.toLowerCase() === 'details') {
          el.open = true;
        }
        el.scrollIntoView({ block: 'start' });
      }

      function setTooth(toothId, pushHash, topicIdToOpen) {
        if (!toothId) return;

        let found = false;
        toothButtons.forEach(b => {
          const match = b.getAttribute('data-select-tooth') === toothId;
          b.setAttribute('aria-pressed', match ? 'true' : 'false');
        });

        teeth.forEach(t => {
          const match = t.getAttribute('data-tooth-id') === toothId;
          t.setAttribute('data-active', match ? 'true' : 'false');
          if (match) found = true;
        });

        if (found && pushHash) {
          history.replaceState(null, '', '#protocol|tooth=' + encodeURIComponent(toothId));
        }

        setupJumpSpy(toothId);
        if (topicIdToOpen) openTopic(toothId, topicIdToOpen);
      }

      archButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const arch = btn.getAttribute('data-arch');
          if (!arch) return;
          setArch(arch);
          const firstVisible = toothItems.find(li => li.style.display !== 'none' && (qs('button', li) && !qs('button', li).disabled));
          const toothId = firstVisible ? firstVisible.getAttribute('data-tooth-id') : null;
          if (toothId) setTooth(toothId, true);
        });
      });

      toothButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const toothId = btn.getAttribute('data-select-tooth');
          if (!toothId) return;
          setTooth(toothId, true);
          const active = qs('.tooth[data-tooth-id="' + CSS.escape(toothId) + '"]');
          if (active) active.scrollIntoView({ block: 'start' });
        });
      });

      document.addEventListener('scroll', setActiveNav, { passive: true });

      // Init
      const { toothId, topicId } = parseHash();
      const activeButtons = toothItems.filter(li => {
        const b = qs('button', li);
        return b && !b.disabled;
      });

      const defaultArch = (activeButtons[0] ? activeButtons[0].getAttribute('data-arch') : 'maxillary') || 'maxillary';
      setArch(defaultArch);

      const firstVisible = toothItems.find(li => li.style.display !== 'none' && (qs('button', li) && !qs('button', li).disabled));
      const fallbackTooth = firstVisible ? firstVisible.getAttribute('data-tooth-id') : null;

      setTooth(toothId || fallbackTooth, true, topicId);
      setActiveNav();
    })();
  </script>
</body>
</html>
